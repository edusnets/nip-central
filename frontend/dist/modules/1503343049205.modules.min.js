'use strict';

(function () {
    angular.module('NipCentral', ['ui.router', 'ngSanitize', 'LocalStorageModule', 'daterangepicker', 'ngMinimalGrid', 'pg.progress-bars']).config(['$httpProvider', '$locationProvider', 'localStorageServiceProvider', 'minimalGridConfigProvider', function ($httpProvider, $locationProvider, localStorageServiceProvider, minimalGridConfigProvider) {

        localStorageServiceProvider.setPrefix('').setStorageType('localStorage').setDefaultToCookie(false);

        // $locationProvider.html5Mode(true).hashPrefix('');

        minimalGridConfigProvider.setStatsMessage('Mostrando %1 à %2 de %3 resultados');
        minimalGridConfigProvider.setFirstLabel('Primeiro');
        minimalGridConfigProvider.setLastLabel('Último');

        $httpProvider.interceptors.push(['$q', 'localStorageService', '$location', 'Settings', function ($q, localStorageService, $location, Settings) {
            return {
                'request': function request(config) {
                    config.headers = config.headers || {};
                    config.headers.Authorization = localStorageService.get(Settings.token);

                    return config;
                },
                'responseError': function responseError(response) {
                    if (response.status == 401) {
                        localStorageService.clear();
                        $location.path('/login');
                    }

                    return $q.reject(response);
                }
            };
        }]);

        $httpProvider.defaults.useXDomain = true;

        delete $httpProvider.defaults.headers.common['X-Requested-With'];
    }]).constant("env", "dev"); //dev || dev-remote || prod
})();
'use strict';

(function () {
   angular.module('NipCentral').controller('NavbarCtrl', ['$scope', 'localStorageService', 'TemplateService', function ($scope, localStorageService, TemplateService) {
      $scope.payload = TemplateService.get();

      $scope.logout = function () {
         localStorageService.clearAll();
      };
   }]);
})();
'use strict';

(function () {
   angular.module('NipCentral').config(['$stateProvider', '$urlRouterProvider', function ($stateProvider, $urlRouterProvider) {

      $urlRouterProvider.otherwise('/login');

      $stateProvider.state('app', {
         url: '/',
         views: {
            'app': {
               template:'<div id="navbar" ui-view="navbar"></div><div id="main-content" ui-view="main"></div>'
            },
            'navbar@app': {
               template:'<nav class="navbar navbar-default navbar-fixed-top navbar-inverse"><div class="container-fluid"><div class="navbar-header"><a class="navbar-brand" href="#"><img src="assets/images/logo-white-text-bg.svg" height="25"></a></div><p style="margin-right:0px" class="navbar-text navbar-right"><a href="#" class="navbar-link" ng-click="logout()" data-toggle="tooltip" title="Logout" data-placement="bottom">{{ payload.nome }} <i class="fa fa-lock"></i></a></p></div><pg-progress-bar name="main"></pg-progress-bar></nav><script>\n$(document).ready(function(){\n	$(\'[data-toggle="tooltip"]\').tooltip()\n});\n</script><style>\n/* Simple progress bar styles */\n.progress__container {\n  width: 100%;\n  height: 3px;\n}\n.progress__container .progress__bar {\n  display: none;\n  height: 3px;\n  background-color: #3d8ec1;\n  width: 0;\n}\n.progress__container_position_fixed {\n  position: fixed;\n  top: 0;\n  left: 0;\n}\n.progress__container_backgrounded {\n  background-color: #d8d8d8;\n}\n.progress__container_color_green .progress__bar {\n  background-color: #4dc84e;\n}\n.progress__container_color_red .progress__bar {\n  background-color: #c8482b;\n}\n.progress__container_showing .progress__bar {\n  display: block;\n}\n</style>',
               controller: 'NavbarCtrl'
            },
            'main@app': {
               template:'<div class="container-fluid"><div ui-view="content"></div></div><footer class="footer"><div class="container-fluid"><p class="text-muted"><br><small>Desenvolvimento NextIp</small></p></div></footer>'
            }
         },
         resolve: ['localStorageService', 'Settings', '$location', function (localStorageService, Settings, $location) {
            if (!localStorageService.get(Settings.token)) {
               $location.href('/login');
            }
         }]
      }).state('app.ligacao', {
         url: 'ligacao',
         views: {
            'content': {
               controller: 'LigacaoCtrl',
               template:'<div class="row"><div class="col-md-12"><i class="fa fa-phone" style="font-size: 18px;margin-right: 10px;display: inline-block;vertical-align: middle;"></i><h2 style="display: inline-block;padding: 0 6px 1px 0px;margin: 30px 0px 0px;text-transform: uppercase;color: #292929;font-size: 16px;font-weight: bold;">Ligações</h2></div></div><div ui-view="ligacao"></div>'
            },
            'ligacao@app.ligacao': {
               controller: 'LigacaoPesquisaCtrl',
               template:'<div class="row"><div class="col-md-12" style="margin: 20px 0"><div style="border: 2px solid #ddd;margin-bottom: -6px;background: #f9f9f9;padding: 15px 0 0;"><div class="col-md-4"><div class="input-group date"><input date-range-picker class="form-control date-picker" type="text" ng-model="range" options="options" style="vertical-align: middle"> <a href="#" class="input-group-addon" style="padding-left: 12px;" ng-click="openDatepicker($event)"><i class="fa fa-calendar"></i></a></div></div><div class="col-md-8"><div class="form-group"><input type="text" ng-model="search" class="form-control" placeholder="Pesquise por qualquer campo"></div></div><br clear="both"></div><minimal-grid columns="fields" on-click-row="showDetails(row)" rows="rows" pagination-max="30"></minimal-grid></div></div>'
            }
         }
      }).state('app.ligacao.detalhes', {
         url: '/detalhes',
         views: {
            'ligacao@app.ligacao': {
               controller: 'LigacaoDetalhesCtrl',
               template:'<div id="ligacao-detalhes" style="padding-top: 20px;border-top: 2px dashed #f0f0f0;margin-top: 30px;"><div class="row"><div class="col-md-6"><h4>Origem</h4><h2 style="margin-top: 0;">{{detalhes.origem}}</h2></div><div class="col-md-6"><h4>Destino</h4><h2 style="margin-top: 0;">{{detalhes.destino}}</h2></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>Id</strong></h5></td><td><h5>{{detalhes.id}}</h5></td></tr><tr><td><h5><strong>Data</strong></h5></td><td><h5>{{detalhes.date}}</h5></td></tr><tr><td><h5><strong>Status</strong></h5></td><td><h5>{{detalhes.status}}</h5></td></tr><tr><td><h5><strong>Áudio</strong></h5></td><td><audio style="width: 100%;" controls><source ng-src="{{detalhes.audio}}" type="audio/wav">Seu browser não suporta este player. Por favor, entre em contato com o nosso suporte.</audio></td></tr></table></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>CallerID</strong></h5></td><td><h5>{{detalhes.caller_id}}</h5></td></tr><tr><td><h5><strong>Conta</strong></h5></td><td><h5>{{detalhes.conta}}</h5></td></tr></table></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>Transferido Por</strong></h5></td><td><h5>{{detalhes.transferido_por}}</h5></td></tr><tr><td><h5><strong>Tipo de Transferência</strong></h5></td><td><h5>{{detalhes.tipo_transferencia}}</h5></td></tr></table></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>Duração</strong></h5></td><td><h5>{{detalhes.duracao}}</h5></td></tr><tr><td><h5><strong>Tarifado</strong></h5></td><td><h5>{{detalhes.faturado}}</h5></td></tr><tr><td><h5><strong>Valor</strong></h5></td><td><h5>{{detalhes.valor}}</h5></td></tr></table></div></div><br><br></div>'
            }
         },
         params: { detalhes: null }
      }).state('login', {
         url: '/login',
         views: {
            'app': {
               controller: 'LoginCtrl',
               template:'<form class="form-signin" name="form-signin"><h3 class="form-signin-heading"><img src="assets/images/logo-white-text-bg.svg" style="display: block;margin: 0 auto;width: 220px;"></h3><br><input type="text" id="inputEmail" name="username" class="form-control" placeholder="Usuário" required autofocus ng-model="user.username"> <input type="password" id="inputPassword" name="password" class="form-control" placeholder="Password" required ng-model="user.password"> <button class="btn btn-lg btn-primary btn-block" type="button" ng-click="entrar()">Entrar</button></form><script>\n    jQuery(\'.form-signin\').keypress(function(e){\n        if(e.charCode === 13){        \n            var btn = jQuery("form[name=\\"form-signin\\"] .btn-primary");\n\n            if((!btn.attr(\'disabled\')) && (!btn.is(\':focus\'))){            \n                btn.click();\n            }\n        }\n    });\n</script>'
            }
         },
         resolve: ['localStorageService', 'Settings', '$location', function (localStorageService, Settings, $location) {
            if (localStorageService.get(Settings.token)) {
               location.href = '#!/ligacao';
            }
         }]
      });
   }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').service('TemplateService', ['localStorageService', function (localStorageService) {
        var get = function get() {
            var explodeToken = localStorageService.get('nip_central').split('.');
            return JSON.parse(window.atob(explodeToken[1]));
        };

        return {
            get: get
        };
    }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').service("Settings", ['env', '$location', function (env, $location) {
        var api = "";

        var apiOptions = {
            local: "http://localhost/nip-central/backend",
            remote: "http://192.168.63.95:4445/api"
        };

        if (env === 'dev') {
            api = apiOptions.local;
        } else if (env === 'dev-remote') {
            api = apiOptions.remote;
        } else if (env === 'prod') {
            var port = "";

            if ($location.port() != "") {
                port = ":" + $location.port();
            }

            api = $location.protocol() + "://" + $location.host() + port + "/api";
        }

        return {
            api: api,
            token: 'nip_central'
        };
    }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').controller('LigacaoCtrl', ['$scope', 'LigacaoService', 'searchFilter', function ($scope, LigacaoService, searchFilter) {}]).controller('LigacaoPesquisaCtrl', ['$scope', '$state', 'LigacaoService', 'searchFilter', 'ProgressBarsStorage', function ($scope, $state, LigacaoService, searchFilter, ProgressBarsStorage) {

        var progressBarTop = ProgressBarsStorage.get('main');
        $scope.rows = [];

        function fancyTimeFormat(time) {
            // Hours, minutes and seconds
            var hrs = ~~(time / 3600);
            var mins = ~~(time % 3600 / 60);
            var secs = time % 60;

            // Output like "1:01" or "4:03:59" or "123:03:59"
            var ret = "";

            if (hrs > 0) {
                ret += "" + hrs + ":" + (mins < 10 ? "0" : "");
            }

            ret += "" + mins + ":" + (secs < 10 ? "0" : "");
            ret += "" + secs;
            return ret;
        }

        $scope.fields = [{
            key: 'date',
            title: 'Data',
            sortable: true,
            formatDate: 'dd/MM/yyyy HH:mm:ss'
        }, {
            key: 'caller_id',
            title: 'CallerID',
            sortable: true
        }, {
            key: 'origem',
            title: 'Origem',
            sortable: true
        }, {
            key: 'destino',
            title: 'Destino',
            sortable: true
        }, {
            key: 'duracao',
            title: 'Duração',
            sortable: true,
            hide: 'hidden-sm hidden-xs',
            onRender: function onRender(val) {
                return fancyTimeFormat(val);
            }
        }, {
            key: 'faturado',
            title: 'Tarifado',
            sortable: true,
            hide: 'hidden-sm hidden-xs',
            onRender: function onRender(val) {
                return fancyTimeFormat(val);
            }
        }, {
            key: 'status',
            title: 'Status',
            sortable: true
        }, {
            key: 'valor',
            title: 'Valor',
            sortable: true
        }, {
            key: 'conta',
            title: 'Conta',
            sortable: true
        }, {
            key: 'transferido_por',
            title: 'Transferido Por',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'tipo_transferencia',
            title: 'Tipo Transf.',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'sentido',
            title: 'Sentido',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'id',
            title: 'Id',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }];

        $scope.showDetails = function (item) {
            $state.go('app.ligacao.detalhes', { detalhes: item });
        };

        $scope.openDatepicker = function (e) {
            $(e.currentTarget).prev().focus();
            e.preventDefault();
        };

        $scope.range = {
            startDate: moment(),
            endDate: moment()
        };

        $scope.$watch('range', function (newRange) {
            if (newRange) {
                progressBarTop.start();
                LigacaoService.get({
                    date_start: newRange.startDate,
                    date_end: newRange.endDate
                }).then(function (response) {
                    $scope.rows = searchFilter(response.data.data, $scope.search);
                    $scope.originalRows = response.data.data;
                }).finally(function () {
                    progressBarTop.done();
                });
            }
        });

        $scope.$watch('search', function (newStr) {
            $scope.rows = searchFilter($scope.originalRows, newStr);
        });

        $scope.options = {
            locale: {
                format: 'DD/MM/YYYY',
                separator: ' - ',
                applyLabel: "Confirmar",
                fromLabel: "De",
                toLabel: "Até",
                cancelLabel: 'Cancelar',
                customRangeLabel: 'Período Customizado',
                daysOfWeek: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                firstDay: 1,
                monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outrubro', 'Novembro', 'Dezembro']
            },
            dateLimit: {
                "days": 31
            },
            ranges: {
                'Hoje': [moment().subtract(0, 'days'), moment()],
                'Últimos 7 dias': [moment().subtract(6, 'days'), moment()],
                'Últimos 30 dias': [moment().subtract(29, 'days'), moment()]
            }
        };
    }]).controller('LigacaoDetalhesCtrl', ['$scope', 'LigacaoService', 'searchFilter', '$stateParams', function ($scope, LigacaoService, searchFilter, $stateParams) {
        $scope.detalhes = $stateParams.detalhes;
    }]).filter('search', function () {
        return function (rows, str) {
            rows = rows || [];

            return rows.filter(function (row) {
                return Object.keys(row).some(function (key) {
                    return new RegExp(str, 'gi').test(row[key].toString());
                });
            });
        };
    });
})();
'use strict';

(function () {
    angular.module('NipCentral').service('LigacaoService', ['$http', 'Settings', function ($http, Settings) {

        function get(filter) {
            return $http.post(Settings.api + '/ligacao', filter);
        }

        return {
            get: get
        };
    }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').controller('LoginCtrl', ['$scope', '$http', '$state', 'localStorageService', 'LoginService', 'TemplateService', 'Settings', function ($scope, $http, $state, localStorageService, LoginService, TemplateService, Settings) {

        $scope.user = {
            username: "",
            password: ""
        };

        $scope.entrar = function () {
            if (localStorageService.isSupported) {
                LoginService.entrar($scope.user).then(function (result) {
                    localStorageService.set(Settings.token, result.data.data.token);
                    $state.go('app.ligacao');
                }, function () {
                    alert("Acesso não autorizado!");
                });
            } else {
                var link = "https://developer.mozilla.org/pt-BR/docs/Web/API/Window/Window.localStorage";

                alert("Para acessar o sistema é necessário habilitar a propriedade LocalStorage. Mais informações: " + link);
            }
        };
    }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').service('LoginService', ['$http', 'Settings', function ($http, Settings) {

        function entrar(credentials) {
            return $http.post(Settings.api + '/login', credentials);
        }

        return {
            entrar: entrar
        };
    }]);
})();