'use strict';

(function () {
    angular.module('NipCentral', ['ui.router', 'ngSanitize', 'LocalStorageModule', 'daterangepicker', 'ngMinimalGrid']).config(['$httpProvider', '$locationProvider', 'localStorageServiceProvider', 'minimalGridConfigProvider', function ($httpProvider, $locationProvider, localStorageServiceProvider, minimalGridConfigProvider) {

        localStorageServiceProvider.setPrefix('').setStorageType('localStorage').setDefaultToCookie(false);

        // $locationProvider.html5Mode(true).hashPrefix('');

        minimalGridConfigProvider.setStatsMessage('Mostrando %1 à %2 de %3 resultados');
        minimalGridConfigProvider.setFirstLabel('Primeiro');
        minimalGridConfigProvider.setLastLabel('Último');

        $httpProvider.interceptors.push(['$q', 'localStorageService', '$location', 'settings', function ($q, localStorageService, $location, settings) {
            return {
                'request': function request(config) {
                    config.headers = config.headers || {};
                    config.headers.Authorization = 'Bearer ' + localStorageService.get(settings.token);

                    return config;
                },
                'responseError': function responseError(response) {
                    if (response.status == 401) {
                        localStorageService.clear();
                        $location.path('/login');
                    }

                    return $q.reject(response);
                }
            };
        }]);

        $httpProvider.defaults.useXDomain = true;

        delete $httpProvider.defaults.headers.common['X-Requested-With'];
    }]).constant("settings", {
        api: "http://192.168.63.95:4445/api",
        token: 'nip_central'
    });
})();
'use strict';

(function () {
   angular.module('NipCentral').controller('NavbarCtrl', ['$scope', 'settings', 'localStorageService', function ($scope, settings, localStorageService) {
      $scope.logout = function () {
         localStorageService.clearAll();
      };
   }]);
})();
'use strict';

(function () {
   angular.module('NipCentral').config(['$stateProvider', '$urlRouterProvider', function ($stateProvider, $urlRouterProvider) {

      $urlRouterProvider.otherwise('/login');

      $stateProvider.state('app', {
         url: '/',
         views: {
            'app': {
               template:'<div id="navbar" ui-view="navbar"></div><div id="main-content" ui-view="main"></div>'
            },
            'navbar@app': {
               template:'<nav class="navbar navbar-default navbar-fixed-top navbar-inverse"><div class="container"><div class="navbar-header"><a class="navbar-brand" href="#"><img src="assets/images/logo-white-text-bg.svg" height="25"></a></div><p style="margin-right:0px" class="navbar-text navbar-right"><a href="#" class="navbar-link" ng-click="logout()">Sair</a></p></div></nav>',
               controller: 'NavbarCtrl'
            },
            'main@app': {
               template:'<div class="container"><div ui-view="content"></div></div><footer class="footer"><div class="container"><p class="text-muted"><small>Desenvolvimento NextIp</small></p></div></footer>'
            }
         },
         resolve: ['localStorageService', 'settings', '$location', function (localStorageService, settings, $location) {
            if (!localStorageService.get(settings.token)) {
               $location.href('/login');
            }
         }]
      }).state('app.ligacao', {
         url: 'ligacao',
         views: {
            'content': {
               controller: 'LigacaoCtrl',
               template:'<div class="row"><div class="col-md-12"><i class="fa fa-phone" style="font-size: 18px;margin-right: 10px;display: inline-block;vertical-align: middle;"></i><h2 style="display: inline-block;padding: 0 6px 1px 0px;margin: 30px 0px 0px;text-transform: uppercase;color: #292929;font-size: 16px;font-weight: bold;">Ligações</h2></div></div><div ui-view="ligacao"></div>'
            },
            'ligacao@app.ligacao': {
               controller: 'LigacaoPesquisaCtrl',
               template:'<div class="row"><div class="col-md-12" style="margin: 20px 0"><div style="border: 2px solid #ddd;margin-bottom: -6px;background: #f9f9f9;padding: 15px 0 0;"><div class="col-md-4"><div class="input-group date"><input date-range-picker class="form-control date-picker" type="text" ng-model="range" options="options" style="vertical-align: middle"> <a href="#" class="input-group-addon" style="padding-left: 12px;" ng-click="openDatepicker($event)"><i class="fa fa-calendar"></i></a></div></div><div class="col-md-8"><div class="form-group"><input type="text" ng-model="search" class="form-control" placeholder="Pesquise por qualquer campo"></div></div><br clear="both"></div><minimal-grid columns="fields" on-click-row="showDetails(row)" rows="rows" pagination-max="15"></minimal-grid></div></div>'
            }
         }
      }).state('app.ligacao.detalhes', {
         url: '/detalhes',
         views: {
            'ligacao@app.ligacao': {
               controller: 'LigacaoDetalhesCtrl',
               template:'<div id="ligacao-detalhes" style="padding-top: 20px;border-top: 2px dashed #f0f0f0;margin-top: 30px;"><div class="row"><div class="col-md-6"><h4>Origem</h4><h2 style="margin-top: 0;">{{detalhes.realsrc}}</h2></div><div class="col-md-6"><h4>Destino</h4><h2 style="margin-top: 0;">{{detalhes.realdst}}</h2></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>Id</strong></h5></td><td><h5>{{detalhes.linkedid}}</h5></td></tr><tr><td><h5><strong>Data</strong></h5></td><td><h5>{{detalhes.calldate}}</h5></td></tr><tr><td><h5><strong>Status</strong></h5></td><td><h5>{{detalhes.disposition}}</h5></td></tr><tr><td><h5><strong>Áudio</strong></h5></td><td><audio style="width: 100%;" controls><source ng-src="{{detalhes.audio}}" type="audio/wav">Seu browser não suporta este player. Por favor, entre em contato com o nosso suporte.</audio></td></tr></table></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>CallerID</strong></h5></td><td><h5>{{detalhes.realclid}}</h5></td></tr><tr><td><h5><strong>Conta</strong></h5></td><td><h5>{{detalhes.accountcode}}</h5></td></tr></table></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>Transferido Por</strong></h5></td><td><h5>{{detalhes.realtransf}}</h5></td></tr><tr><td><h5><strong>Tipo de Transferência</strong></h5></td><td><h5>{{detalhes.realtipotransf}}</h5></td></tr></table></div></div><div class="row" style="margin-top: 20px"><div class="col-md-12"><table style="width: 100%;"><tr><td><h5><strong>Duração</strong></h5></td><td><h5>{{detalhes.duration}}</h5></td></tr><tr><td><h5><strong>Tarifado</strong></h5></td><td><h5>{{detalhes.billsec}}</h5></td></tr><tr><td><h5><strong>Valor</strong></h5></td><td><h5>{{detalhes.valor}}</h5></td></tr></table></div></div><br><br></div>'
            }
         },
         params: { detalhes: null }
      }).state('login', {
         url: '/login',
         views: {
            'app': {
               controller: 'LoginCtrl',
               template:'<form class="form-signin"><h3 class="form-signin-heading"><img src="assets/images/logo-white-text-bg.svg" style="display: block;margin: 0 auto;width: 220px;"></h3><br><input type="text" id="inputEmail" name="username" class="form-control" placeholder="Usuário" required autofocus ng-model="user.email"> <input type="password" id="inputPassword" name="password" class="form-control" placeholder="Password" required ng-model="user.password"> <button class="btn btn-lg btn-primary btn-block" type="button" ng-click="entrar()">Entrar</button></form>'
            }
         },
         resolve: ['localStorageService', 'settings', '$location', function (localStorageService, settings, $location) {
            if (localStorageService.get(settings.token)) {
               $location.href('/ligacao');
            }
         }]
      });
   }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').controller('LigacaoCtrl', ['$scope', '$http', 'settings', 'LigacaoService', 'searchFilter', function ($scope, $http, settings, LigacaoService, searchFilter) {}]).controller('LigacaoPesquisaCtrl', ['$scope', '$http', '$state', 'settings', 'LigacaoService', 'searchFilter', function ($scope, $http, $state, settings, LigacaoService, searchFilter) {

        $scope.rows = [];

        $scope.fields = [{
            key: 'calldate',
            title: 'Data',
            sortable: true
        }, {
            key: 'realclid',
            title: 'CallerID',
            sortable: true
        }, {
            key: 'realsrc',
            title: 'Origem',
            sortable: true
        }, {
            key: 'realdst',
            title: 'Destino',
            sortable: true
        }, {
            key: 'duration',
            title: 'Duração',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'billsec',
            title: 'Tarifado',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'disposition',
            title: 'Status',
            sortable: true
        }, {
            key: 'valor',
            title: 'Valor',
            sortable: true
        }, {
            key: 'accountcode',
            title: 'Conta',
            sortable: true
        }, {
            key: 'realtransf',
            title: 'Transferido Por',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'realtipotransf',
            title: 'Tipo Transf.',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }, {
            key: 'linkedid',
            title: 'Id',
            sortable: true,
            hide: 'hidden-sm hidden-xs'
        }];

        $scope.showDetails = function (item) {
            $state.go('app.ligacao.detalhes', { detalhes: item });
        };

        $scope.openDatepicker = function (e) {
            $(e.currentTarget).prev().focus();
            e.preventDefault();
        };

        $scope.range = {
            startDate: moment(moment().subtract(6, 'days'), moment()).format('YYYY-MM-DD'),
            endDate: moment().format('YYYY-MM-DD')
        };

        $scope.$watch('range', function (newRange) {
            if (newRange) {
                LigacaoService.get({
                    date_start: newRange.startDate,
                    date_end: newRange.endDate
                }).then(function (response) {
                    $scope.rows = searchFilter(response.data, $scope.search);
                    $scope.originalRows = response.data;
                });
            }
        });

        $scope.$watch('search', function (newStr) {
            $scope.rows = searchFilter($scope.originalRows, newStr);
        });

        $scope.options = {
            locale: {
                format: 'DD/MM/YYYY',
                separator: '-',
                applyLabel: "Confirmar",
                fromLabel: "De",
                toLabel: "Até",
                cancelLabel: 'Cancelar',
                customRangeLabel: 'Período Customizado',
                daysOfWeek: ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'],
                firstDay: 1,
                monthNames: ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outrubro', 'Novembro', 'Dezembro']
            },
            ranges: {
                'Hoje': [moment().subtract(0, 'days'), moment()],
                'Últimos 7 dias': [moment().subtract(6, 'days'), moment()],
                'Últimos 30 dias': [moment().subtract(29, 'days'), moment()]
            }
        };
    }]).controller('LigacaoDetalhesCtrl', ['$scope', '$http', 'settings', 'LigacaoService', 'searchFilter', '$stateParams', function ($scope, $http, settings, LigacaoService, searchFilter, $stateParams) {
        $scope.detalhes = $stateParams.detalhes;
    }]).filter('search', function () {
        return function (rows, str) {
            rows = rows || [];

            return rows.filter(function (row) {
                return Object.keys(row).some(function (key) {
                    return new RegExp(str, 'gi').test(row[key].toString());
                });
            });
        };
    });
})();
'use strict';

(function () {
    angular.module('NipCentral').service('LigacaoService', ['$http', 'settings', function ($http, settings) {

        function get(filter) {
            return $http.post(settings + '/ligacao', filter);
        }

        return {
            get: get
        };
    }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').controller('LoginCtrl', ['$scope', '$http', '$state', 'localStorageService', 'LoginService', 'settings', function ($scope, $http, $state, localStorageService, LoginService, settings) {

        $scope.user = {
            email: "",
            password: ""
        };

        $scope.entrar = function () {
            if (localStorageService.isSupported) {
                LoginService.entrar($scope.user).then(function (result) {
                    localStorageService.set(settings.token, result.data.token);
                    $state.go('app.ligacao');
                }, function () {
                    alert("Acesso não autorizado!");
                });
            } else {
                var link = "https://developer.mozilla.org/pt-BR/docs/Web/API/Window/Window.localStorage";

                alert("Para acessar o sistema é necessário habilitar a propriedade LocalStorage. Mais informações: " + link);
            }
        };
    }]);
})();
'use strict';

(function () {
    angular.module('NipCentral').service('LoginService', ['$http', 'settings', function ($http, settings) {

        function entrar(credentials) {
            return $http.post(settings.api + '/login', credentials);
        }

        return {
            entrar: entrar
        };
    }]);
})();